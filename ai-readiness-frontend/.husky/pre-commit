#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ›¡ï¸ VALIDATION SYSTEM: Running pre-commit validation"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No TypeScript/JavaScript files to validate"
  exit 0
fi

echo "ğŸ“ Files to validate:"
echo "$STAGED_FILES" | sed 's/^/  â€¢ /'

# Validate each staged file
VALIDATION_FAILED=false

for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    echo "\nğŸ” Validating: $FILE"
    
    # Run pre-commit validation
    if ! node .claude/hooks/validate-wrapper.js pre "$FILE"; then
      echo "âŒ Validation failed for: $FILE"
      VALIDATION_FAILED=true
    else
      echo "âœ… Validation passed for: $FILE"
    fi
  fi
done

# Run additional checks
echo "\nğŸ”§ Running additional checks..."

# Type checking
if ! npm run type-check; then
  echo "âŒ TypeScript type checking failed"
  VALIDATION_FAILED=true
else
  echo "âœ… TypeScript type checking passed"
fi

# Linting
if ! npm run lint; then
  echo "âŒ ESLint validation failed"
  VALIDATION_FAILED=true
else
  echo "âœ… ESLint validation passed"
fi

# Component boundaries validation
if ! npm run validate:components; then
  echo "âŒ Component boundaries validation failed"
  VALIDATION_FAILED=true
else
  echo "âœ… Component boundaries validation passed"
fi

if [ "$VALIDATION_FAILED" = true ]; then
  echo "\nğŸ’¥ COMMIT BLOCKED: Validation failures detected!"
  echo "ğŸ”§ Fix the issues above and try again."
  echo "ğŸ’¡ Run 'npm run validate:all' to see detailed validation report"
  exit 1
fi

echo "\nğŸ‰ All validations passed! Commit proceeding..."