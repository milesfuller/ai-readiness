#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🛡️ VALIDATION SYSTEM: Running pre-commit validation"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "✅ No TypeScript/JavaScript files to validate"
  exit 0
fi

echo "📁 Files to validate:"
echo "$STAGED_FILES" | sed 's/^/  • /'

# Validate each staged file
VALIDATION_FAILED=false

for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    echo "\n🔍 Validating: $FILE"
    
    # Run pre-commit validation
    if ! node .claude/hooks/validate-wrapper.js pre "$FILE"; then
      echo "❌ Validation failed for: $FILE"
      VALIDATION_FAILED=true
    else
      echo "✅ Validation passed for: $FILE"
    fi
  fi
done

# Run additional checks
echo "\n🔧 Running additional checks..."

# Type checking
if ! npm run type-check; then
  echo "❌ TypeScript type checking failed"
  VALIDATION_FAILED=true
else
  echo "✅ TypeScript type checking passed"
fi

# Linting
if ! npm run lint; then
  echo "❌ ESLint validation failed"
  VALIDATION_FAILED=true
else
  echo "✅ ESLint validation passed"
fi

# Component boundaries validation
if ! npm run validate:components; then
  echo "❌ Component boundaries validation failed"
  VALIDATION_FAILED=true
else
  echo "✅ Component boundaries validation passed"
fi

if [ "$VALIDATION_FAILED" = true ]; then
  echo "\n💥 COMMIT BLOCKED: Validation failures detected!"
  echo "🔧 Fix the issues above and try again."
  echo "💡 Run 'npm run validate:all' to see detailed validation report"
  exit 1
fi

echo "\n🎉 All validations passed! Commit proceeding..."